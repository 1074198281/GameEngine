# 基于物理的渲染理论

[TOC]

# 基础数学原理

## 1.立体角

指球面上所包含面积与半径平方的比。对于一个半径为r的球，它的表面上某一块的面积记作A，立体角Ω表示为

Ω = A / r²。

<img src="Image\立体角.png" alt="立体角" style="zoom:50%;" />

### 1.1 单位立体角

指一个**半径为1**的球面上**1平方米面积**所张成的立体角。

![单位立体角推导](Image\单位立体角推导.jpg)

## 2.辐射度量学

常见的辐射量：辐射通量、辐射强度、辐射照度、辐射亮度、

### 2.1 辐射通量（radiance flux）

辐射通量是指单位时间内通过表面或者空间区域的总能量。单位：流明、瓦特。表示为**φ**。辐射通量越大，亮度越大。

### 2.2 辐射强度 （radiant insensity）

辐射强度是点光源发出的**每单位立体角**的辐射通量。单位：坎德拉。表示为  **I(ω) = dφ / dω**。

### 2.3 辐射照度（Irradiance）

辐射照度是表面**每单位照射面积**接受的辐射通量。单位：勒克斯。表示为  **E(x) ≡ dφ(x) / dA**。

辐射照度指的是每单位照射面积接受的通量，当光线垂直入射时面积为A，斜着入射时被照射的面积为**A‘ = A / cosθ** ，面积变大，光束扩大到更大的区域，意味着每单位区域接受的通量越小。

**朗伯余弦定律：光线到达表面的辐射通量与表面法线和入射光方向夹角成比例、**

此外，表面接受的辐射照度还有距离有关，且与距离的平方成反比。说明距离越远，表面接受的辐射通量越少。

### 2.4 辐射亮度（radiance）

辐射亮度指**每单位投影面积**，**每单位立体角**接受的辐射通量。单位：尼特。表示为**L(p,ω) = dφ(p,ω) / dωdAcosθ**。

辐射亮度描述了光在传播过程中的亮度，它不随距离和方向变化。

## 3.微观几何

[reference:https://zhuanlan.zhihu.com/p/633527357]

比波长大得多的表面不规则性会改变表面的局部方向，当这些不规则性小于像素大小时，我们称为 **微观几何(microgeometry)**。它的核心是认为每个微表面都有自己的法向量，它们的分布对整体的法向量有贡献，最终的表面外观是许多 **具有不同表面取向的点的聚合结果** 。

对于大多数表面而言，微观几何表面法线分布是连续且各项同性的，并且在宏观表面法线较强处呈现较强峰值。这种分布“紧密度”由表面 **粗糙度(roughness)** 决定。表面越粗糙，则微观几何法线就会更加“扩散”。也就是说，在微观尺度上，表面越粗糙，反射越模糊，因为表面取向与整个宏观表面取向的偏离更强。也就是说，微表面法线影响宏观表面的反射率。

## 4.菲涅尔效应

**菲涅尔效应(fresnel effect)** 指的是反射随着 **掠射角(glancing angle, 入射光与表面的夹角)** 的增大而增强。如下图，三张图的书都垂直于表面放置，唯一不同的是拍摄的角度(掠射角)。当垂直入射时，几乎看不到反射。当接近grazing angle(浅入射角，入射光与表面平行)时，反射十分强烈。

通过上述例子，我们可以得出，某种材质的反射光强度与入射角度有关。光打到表面上，会进行折射与反射。而 **菲涅尔方程(fresnel equations)** 描述了从表面反射出来的光的数量。给定折射率(IOR)和掠射角，菲涅尔方程给出该材质在两种介质下入射该表面的反射率。

由于菲涅尔方程的复杂性，在实时渲染中，一般使用 **Schlick近似公式：F(n, l) = F + (1 - F) * pow(1 - cosθ, 5)**。

**个人理解下的菲涅尔效应是输入当前表面材质的反射率，得到在一定角度反射下的反射率，反射率最终其实就是反射光的频率，也就是金属材质的颜色属性。**



# PBR的核心理论

基于物理的渲染（Physically Based Rendering，PBR）是指使用基于物理原理和微平面理论建模的着色/光照模型，以及使用从现实中测量的表面参数来准确表示真实世界材质的渲染理念。

## 1.微平面理论

微平面理论是将物体表面建模成做无数微观尺度上有随机朝向的理想镜面反射的小平面（microfacet）的理论。在实际的PBR 工作流中，这种物体表面的不规则性用粗糙度贴图或者高光度贴图来表示。

### 1.1 光与非光学平坦表面的交互原理

光在与非光学平坦表面（Non-Optically-Flat Surfaces）的交互时，非光学平坦表面表现得像一个微小的光学平面表面的大集合。表面上的每个点都会以略微不同的方向对入射光反射，而最终的表面外观是许多具有不同表面取向的点的聚合结果。 

![非光学平坦表面的可见光反射是来自具有不同方向的许多表面点的反射的总体结果](Image\非光学平坦表面的可见光反射是来自具有不同方向的许多表面点的反射的总体结果.png)

在微观尺度上，表面越粗糙，反射越模糊，因为表面取向与整个宏观表面取向的偏离更强。

![微观尺度的粗糙表面与宏观表面取向](Image\微观尺度的粗糙表面与宏观表面取向.png)

出于着色目的，通常使用统计方法来处理这种微观几何现象，并将表面视为每个点在处在多个方向上反射（和折射）光。

对于从表面折射的光，取决于对象本身的特性：对于金属，折射光会被立刻吸收--能量被自由电子立即吸收；对于非金属，一旦光在其内部折射，表现为常规的参与介质，表现出吸收和散射两种行为。

### 1.2 漫反射和次表面散射本质相同

另外，漫反射和次表面散射其实是相同物理现象，本质都是折射光的次表面散射的结果。唯一的区别是相对于观察尺度的散射距离。散射距离相较于像素来说微不足道，次表面散射便可以近似为漫反射。也就是说，光的折射现象，建模为漫反射还是次表面散射，取决于观察的尺度。

![漫反射与次表面散射](Image\漫反射与次表面散射.png)



### 1.3 PBR的范畴

基于物理的渲染的范畴，由三部分组成：基于物理的材质、基于物理的光照、基于物理适配的相机。

## 2.能量守恒

出射光线的能量永远不能超过入射光线的能量。随着粗糙度的上升镜面反射区域的面积会增加，作为平衡，镜面反射区域的平均亮度则会下降。

## 3.菲涅尔反射

光线以不同角度入射会有不同的反射率。相同的入射角度，不同的物质也会有不同的反射率。万物皆有菲涅尔反射。F0是即 0 度角入射的菲涅尔反射值。大多数非金属的F0范围是0.02~0.04，大多数金属的F0范围是0.7~1.0。

## 4.线性空间

光照计算必须在线性空间完成，shader 中输入的gamma空间的贴图比如漫反射贴图需要被转成线性空间，在具体操作时需要根据不同引擎和渲染器的不同做不同的操作。而描述物体表面属性的贴图如粗糙度，高光贴图，金属贴图等必须保证是线性空间。

## 5.色调映射

是将宽范围的照明级别拟合到屏幕有限色域内的过程。因为基于HDR渲染出来的亮度值会超过显示器能够显示最大亮度，所以需要使用色调映射，将光照结果从HDR转换为显示器能够正常显示的LDR。

## 6.物质的光学特性

现实世界中有不同类型的物质可分为三大类：绝缘体（Insulators），半导体（semi-conductors）和导体（conductors）。在渲染和游戏领域，我们一般只对其中的两个感兴趣：导体（金属）和绝缘体（电解质，非金属）。其中非金属具有单色/灰色镜面反射颜色。而金属具有彩色的镜面反射颜色。即非金属的F0是一个float。而金属的F0是一个float3。

# 渲染方程与BxDF

程作为渲染领域中的重要理论，将BxDF代入渲染方程是求解渲染问题的一般方法。

![渲染方程与BxDF](Image\渲染方程与BxDF.png)

## 2.1 渲染方程与反射方程

渲染方程描述了光能在场景中的流动，是渲染中不可感知方面最抽象的正式表示。根据光学的物理学原理渲染方程在理论上给出了一个完美的结果，各种各样的渲染技术只是理想结果的一个近似。

渲染方程的物理基础是能量守恒定律。在一个特定的位置和方向，出射光Lo是自发光Le与反射光线之和，反射光线本身是哥哥方向的入射光Li之和乘以表面反射率以及入射角。

这个方程经过交叉点将出射光线与入射光线联系在一起，它代表了场景中全部的'光线传输。所有更加完善的算法都可以看作是这个方程的特殊形式的解。

某一点p的渲染方程，可以表示为：
$$
\pmb{L}_o = \pmb{L}_e+\int_\Omega f_r *\pmb{L}_i * (\omega_i * n) * d\omega_i
$$
Lo是p点的出射光强度。

Le是p点的自发光强度。

fr是p点的入射方向到出射方向的反射比例，即BxDF。

Li是p点入射光强度。

(wi * n)是入射角带来的入射光衰减。

积分是入射方向半球的积分。

在实时渲染中，常用的反射方程是渲染方程的简化版，即不包含自发光的项。

## 2.2 BxDF

BxDF一般而言是对BRDF、BTDF、BSDF、BSSRDF等几种双向分布函数的一个统一的表示。

其中，BSDF可以看做BRDF和BTDF更一般的形式，而且BSDF = BRDF + BTDF。

而BSSRDF和BRDF的不同之处在于，BSSRDF可以指定不同的光线入射位置和出射位置。

在上述这些BxDF中，BRDF最为简单，也最为常用。因为游戏和电影中的大多数物体都是不透明的，用BRDF就完全足够。而BSDF、BTDF、BSSRDF往往更多用于半透明材质和次表面散射材质。

# 漫反射的BRDF模型（Diffuse BRDF）

为了求解渲染方程，需要分别求解diffuse BRDF和 Specular BRDF。

